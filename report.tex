% vim: textwidth=99 spell spelllang=en_gb:

\documentclass[nobib, a4paper, twoside, justified]{tufte-book}

\usepackage[utf8]{inputenc}
\usepackage[british]{babel}
\usepackage{csquotes}
\usepackage[style=verbose, autocite=footnote, backend=biber]{biblatex}

\title{Displaying Heraldic Blazons}
\author{William Mathewson}
\publisher{University of Edinburgh}
\date{January 2018}

\addbibresource{bibliography.bib}

%%%%
%%
%% LOCALS are in `tufte-book-local.tex'

\usepackage{graphicx} % allow embedded images
\setkeys{Gin}{width=\linewidth,totalheight=\textheight,keepaspectratio}
\graphicspath{{graphics/}} % set of paths to search for images
\usepackage{amsmath}  % extended mathematics
\usepackage{booktabs} % book-quality tables
\usepackage{units}    % non-stacked fractions and better unit spacing
\usepackage{multicol} % multiple column layout facilities
\usepackage{fancyvrb} % extended verbatim environments
\usepackage{amsmath}
\usepackage{xspace}
\usepackage{makeidx}
\usepackage{mathtools}

\usepackage{float}
\usepackage{subfig}

\usepackage[final]{pdfpages}

%% Tell hyperref package it may break long URLs however it feels
\usepackage{hyperref}
\def\UrlBreaks{\do\/\do-}

%\newcommand{\dcim}{\emph{DCIM}\@\xspace}
%\newcommand{\ipam}{\emph{IPAM}\@\xspace}
%\newcommand{\dcimipam}{\emph{DCIM \& IPAM}\@\xspace}
%\newcommand{\desired}{\emph{desired}\@\xspace}
%\newcommand{\operational}{\emph{operational}\@\xspace}
%\newcommand{\wikid}{\textsc{WikiD}\@\xspace}
%\newcommand{\pywikid}{\textit{pywikid}\@\xspace}
\newcommand{\code}[1]{\texttt{#1}}
%\newcommand{\pythonthree}{Python$3$\@\xspace}

\newcommand{\footnoteurl}[1]{\footnote{\url{#1}}}

%\newcommand{\defeq}{\stackrel{\mathclap{\normalfont\mbox{def}}}{=}}
%\newcommand{\namedmap}[1]{\stackrel{\mathclap{\mbox{\small#1}}}{\longmapsto}}

%% R_{x->y} style
%\newcommand{\relate}[3]{\text{\itshape#1 }_{#2\ \mapsto\ #3}}

%% x --R--> y style
%\newcommand{\relate}[3]{#2\namedmap{#1}#3}

%% xRy style
%\newcommand{\relate}[3]{_{#2}#1_{#3}}

%\newcommand{\citetodo}{\sidenote{\todo{[Citation Needed]}}\@\xspace}
%\newcommand{\reftodo}{\sidenote{\todo{[Reference Needed]}}\@\xspace}
%\newcommand{\prooftodo}{\sidenote{\todo{[Substantiation Needed]}}\@\xspace}
\newcommand{\todo}[1]{{\noindent\textcolor{Red}{\textit{\quad#1}}\par}}

%%  Service description table
%
%\newcommand{\servicedesc}[4]{%
%  \vspace{\baselineskip}%
%  \noindent%
%  {%
%    \footnotesize%
%    \begin{tabular}{llll}%
%      \textbf{Service Name}  & \textbf{Type}  & \textbf{Graph} & \textbf{Integrates with}\\%
%      #1                     & #2             & #4             & #3  \\%
%    \end{tabular}%
%  }%
%  \vspace{\baselineskip}%
%}

\let\lines\baselineskip

\begin{document}

\frontmatter

\maketitlepage

%\abstract{This is an example of {\tt infthesis} style. The file {\tt
%skeleton.tex} generates this document and can be used to get a ``skeleton''
%for your thesis. The abstract should summarise your report and fit in the
%space on the first page.
%%
%You may, of course, use any other software to write your report, as long as
%you follow the same style. That means: producing a title page as given here,
%and including a table of contents and bibliography.  }

\begin{publicationmeta}
  \section*{Acknowledgements}
  % TODO: Think of people to acknowledge
  % I'd like to acknowledge Jesus for swapping bottles whilst I was drinking them. It was really
  % difficult to find him at the bottom, so I had to keep drinking.

  \section*{Declaration}
  I declare that this thesis was composed by myself,
  that the work contained herein is my own
  except where explicitly stated otherwise in the text,
  and that this work has not been submitted for any other degree or
  professional qualification except as specified.\par
  ({\textit \thanklessauthor})
\end{publicationmeta}

\tableofcontents

%\pagenumbering{Arabic}

\mainmatter

\chapter{Introduction}\label{cha:introduction}

\section{Motivation}\label{sec:motivation}

In 1874 --- 4 years after his death --- John Papworth's \textit{Ordinary of British Armorials} was
published~\autocite{collins_1942}. In this work, he recorded approximately 50,000 entries of
descriptions of families' coats of arms, none annotated.

This honours project would make it possible to have these descriptions, or \textit{blazons} as they
are termed in heraldry (see~\ref{sec:heraldry}), drawn freely for people to view. This has
potential application for ancestry companies that build family trees for people. Given the blazon,
they would be able to construct the shields visually.

\section{Contributions}\label{sec:contributions}

In this honours project, my contributions included:

\begin{itemize}
  \item Drawing the charges and quarters used on the shield, \textit{escutcheon},
  \item Writing the base web server and
  \item Writing the quarter and charge drawing algorithm
\end{itemize}

\chapter{Background}\label{cha:background}

\section{Heraldry}\label{sec:heraldry}

Many families, countries and organisations --- primarily in Europe --- have coats of arms. At the
centre of a coat of arms is a shield known as an \textit{escutcheon}. The language used to describe
how the escutcheon is to be drawn is known as a \textit{blazon}. Blazons have been used since the
Norman conquest and have been refined to a regular language in the process~\autocite{boutell_1864},
although, as John Brooke-Little said, ``many of the supposedly hard and fast rules laid down in
heraldic manuals [including those by heralds] are often ignored.''~\autocite{brooke_little_1985}
This flagrant disregard for the rules introduces difficulty in parsing the blazons as the language
loses some of its regularity.

Blazons have a few key attributes:
\begin{itemize}
  \item The \textit{field}, which is the background of the shield;
  \item \textit{Ordinaries}, which are geometric shapes (an example of which can be seen in
    Figure~\ref{fig:scrope});
  \item \textit{Charges}, which are small emblems, such as fleur-de-lis and lions;
  \item \textit{Variations}, which describe how the field or charge are patterned. Variations can
    indicate patterns such as chequered or coloured lines (an example can be seen in
    Figure~\ref{fig:blason_albert}); and
  \item \textit{Tinctures}, which are the colours and patterns for charges, ordinaries and fields.
\end{itemize}

\begin{marginfigure}
  \centering
  \def\svgwidth{0.8\linewidth}
  \input{graphics/Blason_Albert.pdf_tex}
  \caption{The shield of the town of Albert, France. \textit{Barry of ten argent and
  gules}. Source:~\url{https://en.wikipedia.org/wiki/File:Blason_Albert.svg}}\label{fig:blason_albert}
\end{marginfigure}

The tinctures are derived from Norman French and are divided into 3 groups, typically known as
\textit{metals}, \textit{colours} and \textit{furs}. In British heraldry, the colours are derived
from Norman French and so the names appear archaic. In heraldry, blue is \textit{azure} and red is
\textit{gules} for instance. The metals are \textit{or} and \textit{argent} for gold and silver
respectively. Whilst the tinctures are linked to colours, the College of Arms does not which shade
of that colour is required for the tinctures, leaving it to the artist to
decide~\autocite{college_of_arms_faq}.

Blazons conventionally follow a form of starting with the \textit{tincture} or \textit{variation}
of the field. After the description of the field, \textit{ordinaries} and \textit{charges} are
named with their tinctures. An example of this is ``\textit{Purpure, a chief Gules}''. This blazon
describes an escutcheon with a field of \textit{purpure} (purple), with a \textit{Chief} ordinary
--- a bar across the top of the shield --- of \textit{gules} (red). This can be seen drawn by the
web app in Figure~\ref{fig:chief_example}.

\begin{marginfigure}
  \centering
  \def\svgwidth{0.8\linewidth}
  \input{graphics/chief_example.pdf_tex}
  \caption{\textit{Purpure, a chief Gules}.}\label{fig:chief_example}
\end{marginfigure}

% Take out the history lesson?
A simple --- but notable --- blazon is that of the Scrope family. In the 14th century, the Baron
Scrope brought a case action against Sir Roberts Grosvenor when he noticed that they both had the
same coat of arms. Many witnesses gave evidence in the case, including Geoffrey
Chaucer~\autocite{scrope_grosvenor}. The case was ultimately decided in Scrope's favour. The Scrope
coat of arms has a blazon of \textit{Azure, a bend Or}; a depiction of this as drawn by the web app
written for this project can be seen in Figure~\ref{fig:scrope}.

\begin{marginfigure}
  \centering
  \def\svgwidth{0.8\linewidth}
  \input{graphics/scrope.pdf_tex}
  \caption{The Scrope escutcheon; \textit{Azure, a bend Or}.}\label{fig:scrope}
\end{marginfigure}

%\pagebreak

Whilst the Scrope arms are prominent in heraldry, they are simplistic and indicative of
medi\ae{}val arms. Coats of arms became more complex as they developed through the centuries, with
instances of \textit{quarterly} shields, \textit{grand-quarterlies} --- quarterlies within
quarterlies --- and \textit{differenced} arms. \textit{Differenced} arms involve adding an
\textit{ordinary} over an existing coat of arms. This was typically used to differentiate similar
looking coats of arms, especially between father and sons. Common examples of differentiated
shields are seen in duchies' coats of arms, particularly those which were given to Charles II's
illegitimate children. Examples of more complex shields can be seen in
Figure~\ref{fig:complex_shields}.

\begin{figure*}[h]
  \subfloat[Neville, 16th Earl of Warwick's coat of arms. An example of grand-quarterlies and
  differenced arms. Source:~\url{https://en.wikipedia.org/wiki/File:Neville_Warwick_Arms.svg}.]{%
    \def\svgwidth{0.3\linewidth} %
    \input{graphics/Neville_Warwick_Arms.pdf_tex}
  }
  \qquad
  \subfloat[A quarterly shield drawn by the web app. \textit{Quarterly: 1st and 4th: Gules, a bend
  Sable; 2nd and 3rd: Azure, a chief Or}. ]{%
    \def\svgwidth{0.28\linewidth}
    \input{graphics/quarterly_example.pdf_tex}
  }
  \caption{Some examples of more complex coats of arms.}\label{fig:complex_shields}
\end{figure*}

For a time, it was considered bad form to repeat a \textit{tincture} in a blazon, and use a
reference to the tincture's previous use. The Heraldic Society gives an example as such:
``\textit{`Azure on a fess argent three billets azure'} [would have been written as] \textit{`Azure
on a fess argent three billets of the first'}''. The `\textit{of the first}' refers to the field's
tincture of azure. This blazon describes a blue shield, with a white bar horizontally across the
middle with 3 white rectangles arranged along the bar. The Heraldic Society advocates repeating
tinctures to reduce ambiguity~\autocite{blazon_in_coa}.

\section{Related Works}%
\label{sec:related_works}

\todo{Add more related works}

Whilst many escutcheons have been drawn and uploaded to WikiMedia in SVG format (some of which have
been used in this report), many appear to have been created in Inkscape~\autocite{inkscape}, rather
than being created programmatically.  Much work has been done in collecting and cataloguing blazons
themselves --- namely John Papworth as mentioned in Section~\ref{sec:motivation}.

\section{Summary}%
\label{sec:background_summary}

In this chapter, we covered basic heraldry, including core terminology, as well as works related to
the project. Core heraldry terminology includes:

\begin{itemize}
  \item \textit{Escutcheon} --- the shield in the coat of arms;
  \item \textit{Field} --- the background of the escutcheon;
  \item \textit{Ordinaries} --- geometric shapes on the escutcheon;
  \item \textit{Charges} --- small emblems, such as fleur-de-lis and lions; and
  \item \textit{Tincture} --- the colours and patterns for charges, ordinaries and fields.
\end{itemize}

\chapter{Design}%
\label{cha:design}

\section{Core Concepts}%
\label{sec:core_concepts}

The core design for this project centred around having a split stack; with a Python back-end
parsing the blazon, serialising it into JSON and passing it to the TypeScript front-end, which
would then draw it onto the webpage. This allowed for large amounts of flexibility, allowing the
two halves of the project to be developed in tandem with the Separation of Concerns principle being
adhered to throughout. It also allows for pluggable rendering implementations as the JSON schema
for drawing payloads can be well-defined. Python seemed like an obvious choice with its good
support for Natural Language Processing (NLP) through the Natural Language Tool Kit (NLTK).
TypeScript was chosen as a nicer alternative to programming in pure JavaScript, thanks to the
addition of powerful features such as types, access control and abstract classes.

The Python back-end would receive a JSON payload from the webpage containing the blazon; it would
then parse the blazon using a Context-Free Grammar (CFG) parser and identify the most important
parts of the blazon. It would then serialise these back into a JSON response to be sent to the
webpage for rendering. The specification was such that if the webpage was given a blazon of
``Azure, a bend Or'', it would return a JSON payload of:

\begin{verbatim}
{
  "field": "azure",
  "charges": [
    {
      "charge": "bend",
      "tincture": "or"
    }
  ]
}
\end{verbatim}

The TypeScript front-end would receive this payload, apply the \textit{azure} CSS class to the
field element, then draw a bend onto the field with an \textit{or} CSS class.

Escutcheons would be drawn using the SVG format for portability across browsers as well as the
defined scalability of SVG images. This allows drawn escutcheons to be embedded elsewhere with
ease, either directly or through rendering the SVGs as other image formats via programmes like
Inkscape.

The back-end was written by my partner, Anthony Gallagher, and the writing of it will not be
covered in this report.

\section{External Dependencies}%
\label{sec:external_dependencies}

The front-end would depend on a pair of libraries for Scalable Vector
Graphics~\autocite{ferraiolo2000scalable} (SVG) rendering and Document Object
Model~\autocite{wood2004document} (DOM) manipulation: the selection library of
D3.js~\autocite{d3js} and jQuery~\autocite{jquery}. D3.js provides many powerful functions for SVG
and DOM manipulation, especially creating and editing elements. It would also rely on jQuery for
further DOM manipulation.

For further assets, SASS~\autocite{sass-lang} would be used as a CSS pre-processor and
Bootswatch~\autocite{bootswatch-flatly} would be used for the base styling.
Webpack~\autocite{webpack} would be used to transpile TypeScript down to JavaScript --- minifying
and uglifying it in the process --- and concatenates all source files and their dependencies into
one main JavaScript \textit{bundle} file. \textit{Minification} of JavaScript assets involves
stripping out all unnecessary whitespace and tokens.  \textit{Uglification} transforms the
JavaScript code by renaming all variables and functions into short, obfuscated names to reduce the
footprint of the assets. These two techniques can decrease loading times of web apps as the browser
have smaller asset payloads to download than the original, raw source code.

\subsection{Development Dependencies}%
\label{sub:development_dependencies}

To maintain code readability and prevent bugs, TSLint~\autocite{tslint} would be used and set up to
automatically run as part of the Travis Continuous Integration~\autocite{travis} (CI) service,
causing a build to fail if the linter detected a style violation. For unit testing,
Jest~\autocite{jest} (with ts-jest~\autocite{ts-jest} for TypeScript support) would be used,
especially for its powerful mocking and expectation matcher functionality. Automated documentation
generation would be provided by TypeDoc~\autocite{typedoc}.

\section{Initial Design}%
\label{sec:initial_design}

The initial design had a specific focus on basic charge drawing, with a plan to produce a new
design for adding quarterly rendering with lessons learnt from implementing charge drawing. The
later design is described in Section~\ref{sec:adding_quarterly_rendering}.

All drawing logic would be client-side, existing in a single module with minimum dependencies. The
shield outline would be rendered on the page on load as part of the HTML template. This helps
support a reliable entry point for the drawing logic as it can easily select the shield element to
begin appending other SVG elements to. Appending these SVG elements allows layering to be achieved
as SVG orders layers based on the order of elements in the document. This would be used to great
effect later when drawing quarters (see Section~\ref{sec:adding_quarterly_rendering}).

The front-end would be designed around functional paradigms; breaking up major functionality into
functions that would deal with smaller, encapsulated functionality, such as adding extra layers to
the HTML template or clearing the shield when drawing a new blazon. This would allow for a steady
API, as the single point of access function would not be renamed but all other functions may be
changed and updated separately. As described in Section~\ref{sec:core_concepts}, the front-end
would first access the \textit{field} value in the parsed JSON payload, apply the value as the CSS
class for the shield and then move onto the charges. It would then iterate over the
\textit{charges} array in the payload, drawing each charge onto the shield and applying the
tincture as the CSS class. Due to SVG layering, as mentioned earlier, if there were multiple
charges specified in the payload, all would be drawn on in the order specified in the array
ordering.

\chapter{Implementation}%
\label{cha:implementation}

\section{Initial Approach}%
\label{sec:initial_approach}

As described in Section~\ref{sec:initial_design}, the initial approach was to have all methods in
the core \texttt{index.ts} file that would be transpiled and loaded in the browser. This meant a
smaller footprint when the code was bundled by Webpack and easier maintenance as all relevant
functions were next to one another, following the Step-Down Rule~\autocite{martin2009clean}.

The web app had a single entry point of \texttt{drawShield(blazon)}, where \texttt{blazon} was the
whole JSON payload returned from the \texttt{/\_parse} endpoint. (See
Section~\ref{sec:core_concepts} for an example payload.) This presented a problem initially as
TypeScript didn't handle the unstructured parsed data well due to it being a JavaScript
\texttt{Object} instance. Attempting to access members of this object (such as \texttt{field})
causes TypeScript to produce an error that the contents might be undefined and thus return a
\texttt{null} object. To fix this, I designed \texttt{interface}s with the expected fields in the
payload; one for the whole object, \texttt{IBlazon}, and one for the charges contained within,
\texttt{ICharge}. Similarly, to avoid problems with strings not matching, I defined 2
\texttt{enum}s to represent the supported tinctures and charges, \texttt{ETincture} and
\texttt{ECharge} respectively. As discussed in Section~\ref{sec:adding_quarterly_rendering}, I
later added another \texttt{enum} for quarters. (All \texttt{interface}s and \texttt{enum}s can be
found in Appendix~\ref{cha:interfaces_and_enums}.) Having fixed this data problem,
\texttt{drawShield(blazon)} was now able to access members of the blazon object safely.

To avoid the problem of overlapping charges, I had to write a \texttt{clearShield()} method that
would iterate over all the \texttt{path} nodes in the SVG block, and delete them. This, however,
promptly deleted the shield outline, so I had to add a check to prevent deleting \texttt{path}
nodes with a \texttt{\#shield} id, instead only removing the CSS class. Having cleared the shield
of any possible obstructions, the \texttt{drawShield} method would then assign the contents of the
\texttt{field} value as the CSS class and iterate over the \texttt{charges} array, passing each
charge to \texttt{drawCharge(charge: ICharge)}.

To draw shapes in SVG, a \texttt{path} node requires a \texttt{d} attributes which contains the
commands for drawing said shape. To generate all these attributes, I drew all the charge shapes in
Inkscape and extracted the \texttt{d} attribute from the generated SVGs.

\section{Adding Quarterly Rendering}%
\label{sec:adding_quarterly_rendering}

\section{Refactoring Charge Rendering}%
\label{sec:refactoring_charge_rendering}

\chapter{Results and Discussion}%
\label{cha:results_and_discussion}

\section{Automated Testing}%
\label{sec:automated_testing}

\section{Rendering Testing}%
\label{sec:rendering_testing}

\chapter{Conclusion}%
\label{cha:conclusion}

\section{Overview}%
\label{sec:overview}

\section{Further Work}%
\label{sec:further_work}



\backmatter

\printbibliography[heading=bibintoc]

\appendix
\setboolean{@mainmatter}{true}

\chapter{Interfaces and Enums}%
\label{cha:interfaces_and_enums}

\begin{verbatim}
enum ETincture {
  /** For specifying Quarters */
  Quarterly = "quarterly",
  /** Gold/yellow */
  Or = "or",
  /** White */
  Argent = "argent",
  /** Blue */
  Azure = "azure",
  /** Red */
  Gules = "gules",
  /** Purple */
  Purpure = "purpure",
  /** Black */
  Sable = "sable",
  /** Green */
  Vert = "vert",
}

enum ECharge {
  Bend = "bend",
  Cross = "cross",
  Chief = "chief",
  Saltire = "saltire",
}

enum EQuarter {
  TL = "quarterly_tl",
  TR = "quarterly_tr",
  BL = "quarterly_bl",
  BR = "quarterly_br",
}

interface ICharge {
  charge: ECharge;
  sinister?: boolean;
  tincture?: ETincture;
}

interface IBlazon {
  field: ETincture;
  charges: ICharge[];
}
\end{verbatim}

\setboolean{@mainmatter}{false}

\end{document}
